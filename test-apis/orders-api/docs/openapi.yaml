openapi: 3.0.3
info:
  title: Orders API
  description: |
    E-commerce Orders API for managing orders, products, and customers.

    ## Authentication
    This API uses OAuth2 with JWT tokens. Obtain tokens from `/auth/token`.

    ## Rate Limiting
    - 1000 requests/hour for authenticated users
    - 100 requests/hour for unauthenticated requests
  version: 2.1.0
  contact:
    name: API Support
    email: api-support@example.com

servers:
  - url: https://api.orders.example.com/v2
    description: Production
  - url: https://staging-api.orders.example.com/v2
    description: Staging
  - url: http://localhost:3000/v2
    description: Local development

security:
  - bearerAuth: []
  - oauth2: [read, write]

tags:
  - name: Orders
    description: Order management endpoints
  - name: Products
    description: Product catalog endpoints
  - name: Customers
    description: Customer management endpoints
  - name: Auth
    description: Authentication endpoints

paths:
  /auth/token:
    post:
      tags: [Auth]
      summary: Get access token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [grant_type]
              properties:
                grant_type:
                  type: string
                  enum: [client_credentials, password]
                client_id:
                  type: string
                client_secret:
                  type: string
                username:
                  type: string
                password:
                  type: string
            examples:
              client_credentials:
                value:
                  grant_type: client_credentials
                  client_id: orders_app_client
                  client_secret: secret123
              password:
                value:
                  grant_type: password
                  username: alice@example.com
                  password: password123
      responses:
        '200':
          description: Token issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'

  /orders:
    get:
      tags: [Orders]
      summary: List orders
      description: Returns orders for the authenticated user. Admins can see all orders.
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, processing, shipped, delivered, cancelled]
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of orders
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
    post:
      tags: [Orders]
      summary: Create order
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrder'
            example:
              customer_id: cust_alice_123
              items:
                - product_id: prod_laptop_001
                  quantity: 1
                - product_id: prod_mouse_002
                  quantity: 2
              shipping_address:
                street: 123 Main St
                city: San Francisco
                state: CA
                zip: "94102"
                country: US
      responses:
        '201':
          description: Order created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'

  /orders/{order_id}:
    get:
      tags: [Orders]
      summary: Get order by ID
      parameters:
        - $ref: '#/components/parameters/OrderId'
      responses:
        '200':
          description: Order details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '403':
          description: Not authorized to view this order
        '404':
          description: Order not found
    put:
      tags: [Orders]
      summary: Update order
      parameters:
        - $ref: '#/components/parameters/OrderId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateOrder'
      responses:
        '200':
          description: Order updated
    delete:
      tags: [Orders]
      summary: Cancel order
      parameters:
        - $ref: '#/components/parameters/OrderId'
      responses:
        '204':
          description: Order cancelled

  /customers:
    get:
      tags: [Customers]
      summary: List customers (admin only)
      responses:
        '200':
          description: List of customers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Customer'
    post:
      tags: [Customers]
      summary: Create customer
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCustomer'
      responses:
        '201':
          description: Customer created

  /customers/{customer_id}:
    get:
      tags: [Customers]
      summary: Get customer profile
      parameters:
        - $ref: '#/components/parameters/CustomerId'
      responses:
        '200':
          description: Customer profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
    put:
      tags: [Customers]
      summary: Update customer profile
      parameters:
        - $ref: '#/components/parameters/CustomerId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCustomer'
      responses:
        '200':
          description: Customer updated

  /customers/{customer_id}/orders:
    get:
      tags: [Customers, Orders]
      summary: Get customer's orders
      parameters:
        - $ref: '#/components/parameters/CustomerId'
      responses:
        '200':
          description: Customer's orders

  /products:
    get:
      tags: [Products]
      summary: List products
      security: []
      parameters:
        - name: category
          in: query
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of products
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Product'

  /products/{product_id}:
    get:
      tags: [Products]
      summary: Get product details
      security: []
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: Product details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    oauth2:
      type: oauth2
      flows:
        clientCredentials:
          tokenUrl: /auth/token
          scopes:
            read: Read access
            write: Write access
            admin: Admin access

  parameters:
    OrderId:
      name: order_id
      in: path
      required: true
      schema:
        type: string
      example: ord_abc123
    CustomerId:
      name: customer_id
      in: path
      required: true
      schema:
        type: string
      example: cust_alice_123
    ProductId:
      name: product_id
      in: path
      required: true
      schema:
        type: string
      example: prod_laptop_001

  schemas:
    Order:
      type: object
      properties:
        id:
          type: string
          example: ord_abc123
        customer_id:
          type: string
          example: cust_alice_123
        status:
          type: string
          enum: [pending, processing, shipped, delivered, cancelled]
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        total:
          type: number
          format: float
        shipping_address:
          $ref: '#/components/schemas/Address'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    OrderItem:
      type: object
      properties:
        product_id:
          type: string
        quantity:
          type: integer
        price:
          type: number

    CreateOrder:
      type: object
      required: [customer_id, items]
      properties:
        customer_id:
          type: string
        items:
          type: array
          items:
            type: object
            properties:
              product_id:
                type: string
              quantity:
                type: integer
        shipping_address:
          $ref: '#/components/schemas/Address'

    UpdateOrder:
      type: object
      properties:
        status:
          type: string
        shipping_address:
          $ref: '#/components/schemas/Address'

    Customer:
      type: object
      properties:
        id:
          type: string
          example: cust_alice_123
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
          enum: [customer, admin]
        created_at:
          type: string
          format: date-time

    CreateCustomer:
      type: object
      required: [email, name, password]
      properties:
        email:
          type: string
        name:
          type: string
        password:
          type: string

    UpdateCustomer:
      type: object
      properties:
        name:
          type: string
        email:
          type: string

    Product:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        price:
          type: number
        category:
          type: string
        stock:
          type: integer

    Address:
      type: object
      properties:
        street:
          type: string
        city:
          type: string
        state:
          type: string
        zip:
          type: string
        country:
          type: string

    Pagination:
      type: object
      properties:
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          example: 3600
